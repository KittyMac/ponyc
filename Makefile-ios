# This makefile eases the compiling of pony for the iOS platform
#
# Prerequisities
# This makefile assumes that you can already compile ponyc normally (you have your llvm paths set)
#
# Sample command:
# make -f Makefile-ios config=release all
#
# Install LLVM (only necessary until I can get this hooked up to the submoduled llvm)
#
#    - curl -o macports.pkg https://distfiles.macports.org/MacPorts/MacPorts-2.6.0-10.14-Mojave.pkg
#    - sudo installer -verbose -pkg macports.pkg -target /
#    - sudo /opt/local/bin/port selfupdate
#    - sudo /opt/local/bin/port install llvm-7.0
#
# Overview:
#
# 1. Compile ponyc as normal
# 2. Compile libponyrt for all desired arm architectures (currently armv7, armv7s, arm64)
# 3. Create a fat binary .a of libponyrt.a; this is what you will include in your XCode project
# 4. [TODO]
# 
# TODO: Compile your pony program into your XCode project
# 
# - Easily compile your pony program into a .o which you can include in XCode
# BUILD YOUR PONY CODE WITH:
# /Volumes/Development/Development/pony/PonyIOS/ponyc/build/release/ponyc --link-arch arm64 --triple arm64-apple-ios -robj
#
# Drag the .o file to your XCode project and build!
#
# TODO: Make the pony runtime play nice on an iOS device

iphonesdk_ar=$(shell xcrun --sdk iphoneos --find ar)
iphonesdk_clang=$(shell xcrun --sdk iphoneos --find clang)
iphonesdk_clangxx=$(shell xcrun --sdk iphoneos --find clang++)
iphonesdk_isysroot=$(shell xcrun --sdk iphoneos --show-sdk-path)
iphonesdklib="$(iphonesdk_isysroot)/usr/lib"

# Note: not sure yet how to get this to work with the version of llvm submoduled
llvm_config=/opt/local/bin/llvm-config-mp-7.0

ponyc:
#Makefile-lib-llvm default_pic=true
#Makefile-ponyc
#CC="$(iphonesdk_clang)" CXX="$(iphonesdk_clangxx)"
	@IPHONESDK="" $(MAKE) -f Makefile-ponyc default_pic=true bits=64 LLVM_CONFIG="$(llvm_config)" -j$(sysctl -n hw.ncpu) config=$(config) all

libponyrt:
	export LDFLAGS="-L$(iphonesdklib)"
	@echo "Compiling libponyrt for armv7"
	@IPHONESDK="$(iphonesdk_isysroot)" $(MAKE) -f Makefile-ponyc arch=armv7 LLVM_CONFIG="$(llvm_config)" CC="$(iphonesdk_clang)" CXX="$(iphonesdk_clangxx)" -j$(sysctl -n hw.ncpu) config=$(config) libponyrt
	@echo "Compiling libponyrt for armv7s"
	@IPHONESDK="$(iphonesdk_isysroot)" $(MAKE) -f Makefile-ponyc arch=armv7s LLVM_CONFIG="$(llvm_config)" CC="$(iphonesdk_clang)" CXX="$(iphonesdk_clangxx)" -j$(sysctl -n hw.ncpu) config=$(config) libponyrt
	@echo "Compiling libponyrt for arm64"
	@IPHONESDK="$(iphonesdk_isysroot)" $(MAKE) -f Makefile-ponyc arch=arm64 LLVM_CONFIG="$(llvm_config)" CC="$(iphonesdk_clang)" CXX="$(iphonesdk_clangxx)" -j$(sysctl -n hw.ncpu) config=$(config) libponyrt
	
	@echo "Making fat binary for libponyrt at build/release/lib/ios/libponyrt.a"
	mkdir -p build/$(config)/lib/ios/
	lipo -create -output build/$(config)/lib/ios/libponyrt.a build/$(config)/lib/armv7/libponyrt.a build/$(config)/lib/armv7s/libponyrt.a build/$(config)/lib/arm64/libponyrt.a

install:
	@IPHONESDK="" $(MAKE) -f Makefile-ponyc LLVM_CONFIG="$(llvm_config)" -j$(sysctl -n hw.ncpu) config=$(config) install

all: ponyc libponyrt
	@echo "all done"

ci: all install

clean:
	$(MAKE) -f Makefile-ponyc config=$(config) clean

