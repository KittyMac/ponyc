# This makefile eases the compiling of pony for the iOS platform
#
# Prerequisities
# This makefile assumes that you can already compile ponyc normally (you have your llvm paths set)
#
# For example:
# export LDFLAGS="-L/opt/local/lib"
# export PATH=/usr/local/opt/llvm/bin/:$PATH
# export CC1=clang
# export CXX1=clang++
# export LLVM_CONFIG=/opt/local/bin/llvm-config-mp-7.0
#
# Sample command:
# make -f Makefile-ios config=release all
#
# Overview:
#
# 1. Compile ponyc as normal
# 2. Compile libponyrt for all desired arm architectures (currently armv7, armv7s, arm64)
# 3. Create a fat binary .a of libponyrt.a; this is what you will include in your XCode project
# 4. [TODO]
# 

iphonesdkroot=$(shell xcrun --show-sdk-platform-path | sed 's/MacOSX/iPhoneOS/g')
iphonesdk="$(iphonesdkroot)/Developer/SDKs/iPhoneOS.sdk"

ponyc:
	@IPHONESDK="" $(MAKE) -f Makefile-ponyc LLVM_CONFIG="$(LLVM_CONFIG)" CC="$(CC1)" CXX="$(CXX1)" -j$(sysctl -n hw.ncpu) config=$(config) all

libponyrt:
	export LDFLAGS="-L$(iphonesdk)/usr/lib"
	@echo "Compiling libponyrt for armv7"
	@IPHONESDK="$(iphonesdk)" $(MAKE) -f Makefile-ponyc arch=armv7 LLVM_CONFIG="$(LLVM_CONFIG)" CC="$(CC1)" CXX="$(CXX1)" -j$(sysctl -n hw.ncpu) config=$(config) libponyrt
	@echo "Compiling libponyrt for armv7s"
	@IPHONESDK="$(iphonesdk)" $(MAKE) -f Makefile-ponyc arch=armv7s LLVM_CONFIG="$(LLVM_CONFIG)" CC="$(CC1)" CXX="$(CXX1)" -j$(sysctl -n hw.ncpu) config=$(config) libponyrt
	@echo "Compiling libponyrt for arm64"
	@IPHONESDK="$(iphonesdk)" $(MAKE) -f Makefile-ponyc arch=arm64 LLVM_CONFIG="$(LLVM_CONFIG)" CC="$(CC1)" CXX="$(CXX1)" -j$(sysctl -n hw.ncpu) config=$(config) libponyrt
	
	@echo "Making fat binary for libponyrt at build/release/lib/ios/libponyrt.a"
	mkdir -p build/release/lib/ios/
	lipo -create -output build/release/lib/ios/libponyrt.a build/release/lib/armv7/libponyrt.a build/release/lib/armv7s/libponyrt.a build/release/lib/arm64/libponyrt.a

all: ponyc libponyrt
	@echo "all done"

clean:
	$(MAKE) -f Makefile-ponyc config=$(config) clean

